local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local plr = Players.LocalPlayer
local cam = Workspace.CurrentCamera

local visited = {}
local bases = {}
local started = false

local function getHumanoidRootPart()
	local char = plr.Character or plr.CharacterAdded:Wait()
	return char:WaitForChild("HumanoidRootPart")
end

local function collectBases()
	bases = {}
	for _, map in pairs(Workspace.Maps:GetChildren()) do
		if map:FindFirstChild("Gameplay") and map.Gameplay:FindFirstChild("Buttons") then
			for _, model in pairs(map.Gameplay.Buttons:GetChildren()) do
				if model:IsA("Model") and model:FindFirstChild("Base") then
					table.insert(bases, model.Base)
				end
			end
		end
	end
end

local function teleportSequence()
	collectBases()

	for _, base in ipairs(bases) do
		if not visited[base] then
			visited[base] = true

			local hrp = getHumanoidRootPart()
			local basePos = base.Position

			local direction = base.CFrame.LookVector.Unit
			local teleportPos = basePos + direction * 5 + Vector3.new(0, 3, 0)

			-- Teleport player (no rotation)
			hrp.CFrame = CFrame.new(teleportPos)

			-- Let physics catch up a bit to avoid freezing
			task.wait(0.1)

			-- Rotate camera using LookVector math
			local camPos = hrp.Position + Vector3.new(0, 2, 0) -- camera slightly above player
			local lookDirection = (basePos - camPos).Unit
			local right = Vector3.new(0, 1, 0):Cross(lookDirection).Unit
			local up = lookDirection:Cross(right).Unit

			cam.CameraType = Enum.CameraType.Scriptable
			cam.CFrame = CFrame.fromMatrix(camPos, right, up)

			task.wait(1)
		end
	end

	-- Reset camera so player regains control
	cam.CameraType = Enum.CameraType.Custom
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.K and not started then
		started = true
		teleportSequence()
	end
end)
